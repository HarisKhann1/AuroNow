{% load static %}
{% load tailwind_tags %}
<form
  action="{% url 'search_results' %}"
  method="GET"
  class="bg-transparent backdrop-blur-xl text-white border border-gray-400 shadow-md rounded-lg lg:rounded-full w-full py-3 md:py-4 lg:py-3 max-w-3xl mx-auto"
>

  <!-- Search Bar -->
  <main class="bg-transparent  text-white rounded-lg lg:rounded-full px-4 w-full">

    <!-- Laptop/Desktop Layout -->
    <div id='desktop' class="hidden lg:flex lg:items-center lg:gap-0">
    
      <!--categories  -->
      <select name="category" class="bg-transparent border-none cursor-pointer  focus:outline-none w-auto focus:ring-0 hover:text-gray-200">
        <option class="text-black " value="">Category</option>
        {% for cat in categories %}
        <option class="text-black " value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>
          {{ cat }}
        </option>
        {% endfor %}
      </select>
      <span class="text-gray-500 h-7">|</span>

      <!--Name Input  -->
      <input 
        type="text" 
        name="shop_name" 
        placeholder="Enter Shop Name" 
        value="{{ request.GET.shop_name }}"
        class="bg-transparent placeholder:text-gray-200 outline-none border-none text-medium flex-grow focus:ring-0 text-white
           [&:-webkit-autofill]:bg-transparent [&:-webkit-autofill]:text-white"
      />
      <span class="text-gray-500">|</span>

      <!-- Location -->
      <select name="city" class="bg-transparent  outline-none text-medium border-none appearance-none w-auto focus:ring-0 hover:text-gray-200">
        <option  class="text-black" value="">Location</option>
        {% for city in cities %}
        <option  class="text-black" value="{{ city }}" {% if request.GET.city == city %}selected{% endif %}>
          {{ city }}
        </option>
        {% endfor %}
      </select>
      <span class="text-gray-500">|</span>
    
      <!--Price -->
      <select name="price" class="bg-transparent outline-none text-medium border-none appearance-none w-auto focus:ring-0 hover:text-gray-200">
        <option  class="text-black" value="">Price</option>
        {% for price in price_ranges %}
        <option class="text-black" value="{{ price }}" {% if request.GET.price == price %}selected{% endif %}>
          {{ price }}
        </option>
        {% endfor %}
      </select>
      <!-- search button -->
     <button type="submit" class="font-semibold bg-primary-color text-gray-700 px-4 py-2 rounded-full hover:bg-primary-hover-color -mr-2">
        Search
      </button>
    </div>

      <!-- Tablet Layout -->
    <div id='tablet' class="hidden md:flex md:flex-col lg:hidden gap-3">
      <div class="grid grid-cols-2 gap-3">
        <!--categories  -->
        <select name="category" class="bg-transparent border-gray-500 rounded focus:border-secondary-color text-medium appearance-none w-full focus:ring-0 hover:text-gray-200">
          <option value="" class="text-black">Category</option>
          {% for cat in categories %}
          <option class="text-black" value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>
            {{ cat }}
          </option>
          {% endfor %}
        </select>

        <!--Name Input  -->
        <input type="text" name="shop_name" placeholder="Enter Shop Name" value="{{ request.GET.shop_name }}"
          class="bg-transparent border-gray-500 rounded focus:border-secondary-color placeholder:text-white  text-medium w-full  focus:ring-0" />

          <!-- Location -->
        <select name="city" class="bg-transparent border-gray-500 rounded focus:border-secondary-color text-medium appearance-none w-full focus:ring-0 hover:text-gray-200">
          <option  class="text-black" value="">Location</option>
          {% for city in cities %}
          <option class="text-black" value="{{ city }}" {% if request.GET.city == city %}selected{% endif %}>
            {{ city }}
          </option>
          {% endfor %}
        </select>

        <!--Price -->
        <select name="price" class="bg-transparent border-gray-500 focus:border-secondary-color rounded text-medium appearance-none w-full focus:ring-0 hover:text-gray-200">
          <option class="text-black" value="">Price</option>
          {% for price in price_ranges %}
          <option class="text-black" value="{{ price }}" {% if request.GET.price == price %}selected{% endif %}>
            {{ price }}
          </option>
          {% endfor %}
        </select>
      </div>
      <!-- search button -->

      <button type="submit" class="bg-primary-color text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-primary-hover-color w-full mx-auto">
        Search
      </button>
    </div>

    <!-- Mobile Layout -->
    <div id='mobile' class="flex flex-col gap-1 w-full md:hidden">
      <!--categories  -->
      <select name="category" class="bg-transparent border-gray-500 rounded focus:border-secondary-color outline-none text-sm appearance-none w-full py-2 focus:ring-0 hover:text-gray-200">
        <option class="text-black" value="" >Category</option>
        {% for cat in categories %}
        <option class="text-black" value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>
          {{ cat }}
        </option>
        {% endfor %}
      </select>

      <!--Name Input  -->
      <input type="text" name="shop_name" placeholder="Enter Shop Name" value="{{ request.GET.shop_name }}"
        class="bg-transparent border-gray-500 rounded focus:border-secondary-color placeholder:text-white text-medium w-full focus:ring-0" />
      
      <div class="flex flex-row gap-1">
        <!-- Location -->
        <select name="city" class="bg-transparent border-gray-500 rounded focus:border-secondary-color text-sm appearance-none w-full py-2 focus:ring-0 hover:text-gray-200">
          <option class="text-black" value="">Location</option>
          {% for city in cities %}
          <option class="text-black" value="{{ city }}" {% if request.GET.city == city %}selected{% endif %}>
            {{ city }}
          </option>
          {% endfor %}
        </select>

        <!--Price -->
        <select name="price" class="bg-transparent border-gray-500 rounded focus:border-secondary-color text-sm appearance-none w-full py-2 focus:ring-0 hover:text-gray-200">
          <option class="text-black" value="">Price</option>
          {% for price in price_ranges %}
          <option class="text-black" value="{{ price }}" {% if request.GET.price == price %}selected{% endif %}>
            {{ price }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- search button -->
      <button type="submit" class="bg-primary-color text-gray-700 px-4 py-2 rounded focus:border-secondary-color hover:bg-primary-hover-color w-full mt-2 focus:ring-0 hover:text-gray-200">
        Search
      </button>
    </div> 

  </main>

</form>

<!-- Near Shops -->
<div class="flex items-center lg:px-6 py-2 w-full max-w-3xl mx-auto">
  <div class="transition duration-300  hover:scale-105 flex items-center gap-2 mt-1">
    {% comment %} <img class="inline-block w-6 h-6 text-indigo-400" src="{% static 'icons/location-icon.png' %}" alt="shop_search_icon"> {% endcomment %}
    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M12 11c1.104 0 2-.896 2-2s-.896-2-2-2-2 .896-2 2 .896 2 2 2z" />
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" />
    </svg>
    <button id="near-shops-btn" type='button' class="inline-block font-semibold text-gray-200 hover:text-number-bg;">Get Near Shops</button>
  </div>
</div>
<!-- Near Shops -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    function updateFormInputs() {
      const desktopForm = document.querySelector("#desktop");
      const tabletForm = document.querySelector("#tablet");
      const mobileForm = document.querySelector("#mobile");
  
      let activeForm = null;
  
      if (window.innerWidth >= 1024) {
        activeForm = desktopForm;
      } else if (window.innerWidth >= 768) {
        activeForm = tabletForm;
      } else {
        activeForm = mobileForm;
      }
  
      if (!activeForm) return; // ðŸ›‘ Stop if no active form is found
  
      document.querySelectorAll("select, input").forEach((el) => {
        if (activeForm.contains(el)) {
          el.removeAttribute("disabled");
        } else {
          el.setAttribute("disabled", "true");
        }
      });
    }
  
    updateFormInputs();
    window.addEventListener("resize", updateFormInputs);
  });

  // get user lati & longi 
 document.getElementById('near-shops-btn').addEventListener('click', function () {
  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser.");
    return;
  }

  this.disabled = true;
  this.textContent = "Locating...";

  // Check if location was previously stored and reuse it
  const storedPos = sessionStorage.getItem('lastKnownPosition');
  if (storedPos) {
    const { lat, lon } = JSON.parse(storedPos);
    redirectToNearbyShops(lat, lon);
    return;
  }

  const geoOptions = {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 10000
  };

  navigator.geolocation.getCurrentPosition(
    async (position) => {
      let { latitude: lat, longitude: lon, accuracy } = position.coords;

      // Round to 6 decimal places
      lat = Number(lat.toFixed(6));
      lon = Number(lon.toFixed(6));

      console.log(`Position: ${lat}, ${lon} (Accuracy: ${accuracy}m)`);

      if (accuracy > 100) {
        if (!confirm(`Your location is only accurate within ${Math.round(accuracy)}m. Continue anyway?`)) {
          resetButton();
          return;
        }
      }

      // Store for future sessions
      sessionStorage.setItem('lastKnownPosition', JSON.stringify({ lat, lon }));
      redirectToNearbyShops(lat, lon);
    },
    (error) => {
      const lastPos = sessionStorage.getItem('lastKnownPosition');
      if (lastPos) {
        if (confirm("Location access blocked. Use your last known position?")) {
          const { lat, lon } = JSON.parse(lastPos);
          redirectToNearbyShops(lat, lon);
          return;
        }
      }

      const errors = {
        1: "Permission denied. Enable location access in browser settings.",
        2: "Could not determine location. Check your network/GPS.",
        3: "Request timed out. Try again in an open area."
      };
      alert(errors[error.code] || "Location unavailable. Try again later.");
      resetButton();
    },
    geoOptions
  );

  function redirectToNearbyShops(lat, lon) {
    try {
      const url = new URL("{% url 'nearby_shops' %}", window.location.origin);
      url.searchParams.set('lat', lat);
      url.searchParams.set('lon', lon);
      window.location.href = url.toString();
    } catch (error) {
      alert("Failed to generate URL. Please try again.");
      resetButton();
    }
  }

  function resetButton() {
    const btn = document.getElementById('near-shops-btn');
    btn.disabled = false;
    btn.textContent = "Find Nearby Shops";
  }
});

</script>

